<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote - VoteSecure</title>
	<link rel="stylesheet" href="common.css">
	<link rel="stylesheet" href="voter.css">
</head>
<body class="voter-page">
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <a href="../index.html">
                    <svg class="logo-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M9 11l3 3L22 4"></path>
                        <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
                    </svg>
                    <span class="logo-text">VoteSecure</span>
                </a>
            </div>
            <div class="nav-actions">
				<!-- <a href="viewElectionDetails.html" class="btn btn-sm btn-secondary">View Election Details</a> -->
                <div id="walletInfo"></div>
                <button id="connectWalletBtn" class="btn btn-sm btn-primary">
                    <span class="service-status loading"></span>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="16" height="16">
                        <rect x="3" y="7" width="18" height="13" rx="2"></rect>
                        <path d="M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2"></path>
                    </svg>
                    <span class="btn-text">Connect JoyID</span>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Loading State -->
            <div id="loadingState" class="loading-state">
                <div class="spinner"></div>
                <p>Loading election...</p>
            </div>

            <!-- Election ID Input -->
            <div id="electionIdInput" class="info-card" style="display: none;">
                <div class="info-icon">üîó</div>
                <h2>Enter Election ID</h2>
                <p>Please use your invitation link.</p>
                <form id="electionIdForm" class="election-id-form">
                    <div class="form-group">
                        <label for="electionIdInputField">Election ID:</label>
                        <input 
                            type="text" 
                            id="electionIdInputField" 
                            placeholder="Paste your election ID from the invitation link"
                            required
                            autocomplete="off"
                        >
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg">Load Election</button>
                </form>
            </div>

            <!-- Error State -->
            <div id="errorState" class="error-state" style="display: none;">
                <div class="error-icon">‚ö†Ô∏è</div>
                <h2>Election Not Found</h2>
                <p id="errorMessage">Unable to load election. Please check your invitation link.</p>
                <a href="../index.html" class="btn btn-primary">Go Home</a>
            </div>

            <!-- Wallet Connection Required -->
            <div id="walletRequired" class="info-card" style="display: none;">
                <div class="info-icon">üîê</div>
                <h2>Connect Your Wallet to Vote</h2>
                <p>To participate in this election, please connect your JoyID wallet.</p>
                <p class="info-text"><strong>Why?</strong> Your wallet authenticates you and encrypts your ballot for privacy.</p>
                <p class="info-text"><strong>Cost:</strong> No CKB needed! The organizer pays all transaction fees.</p>
                <button id="connectBtn" class="btn btn-primary btn-lg">Connect JoyID Wallet</button>
            </div>

            <!-- Election Info & Voting Form -->
            <div id="votingInterface" style="display: none;">
                <!-- Election Header -->
                <div class="election-header">
                    <h1 id="electionTitle">Election Title</h1>
                    <div id="electionDescription" class="election-description"></div>
                    
                    <div class="election-meta">
                        <div class="meta-item">
                            <span class="meta-label">Status:</span>
                            <span id="electionStatus" class="status-badge">Active</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Ends:</span>
                            <span id="electionEndTime">--</span>
                        </div>
                        <div class="meta-item">
                            <span class="meta-label">Participants:</span>
                            <span id="participantCount">--</span>
                        </div>
                    </div>

                    <!-- Privacy Notice (White Paper Compliance) -->
                    <div class="privacy-notice">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="16" height="16">
                            <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        </svg>
                        <p><strong>Privacy Protected:</strong> Your ballot is encrypted client-side. Only aggregate results are revealed per the election's privacy policy.</p>
                    </div>
                </div>

                <!-- Voting Form -->
                <form id="votingForm" class="voting-form">
                    <div id="questionsContainer"></div>

                    <!-- Grouping Fields (if required by event config) -->
                    <div id="groupingFieldsContainer" style="display: none;">
                        <h3>Optional Classification</h3>
                        <p class="field-note">This information helps with k-anonymity analysis and is stored with your ballot.</p>
                        <div id="groupingFields"></div>
                    </div>

                    <!-- Previous Ballot Info -->
                    <div id="previousBallot" class="info-card" style="display: none;">
                        <h4>Update Your Ballot</h4>
                        <p>You have already voted in this election. Submitting again will update your vote.</p>
                        <div class="previous-ballot-info">
                            <div class="info-row">
                                <span>Previous submission:</span>
                                <span id="previousTimestamp">--</span>
                            </div>
                            <div class="info-row">
                                <span>Updates remaining:</span>
                                <span id="updatesRemaining">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Actions -->
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="18" height="18">
                                <path d="M9 11l3 3L22 4"></path>
                                <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
                            </svg>
                            Submit Ballot
                        </button>
                        <p class="form-note">
                            <span id="updateLimitInfo">You can update your ballot multiple times before the deadline.</span><br>
                            Your vote is <strong>encrypted and anonymous</strong>.
                        </p>
                    </div>
                </form>
            </div>

            <!-- Receipt Modal -->
            <div id="receiptModal" class="modal" style="display: none;">
                <div class="modal-overlay" onclick="closeReceiptModal()"></div>
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>‚úì Ballot Submitted Successfully</h2>
                        <button class="modal-close" onclick="closeReceiptModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="receipt-card">
                            <h3>Your Ballot Receipt</h3>
                            <p class="receipt-subtitle">Save this information to verify your vote was included in the final tally.</p>
                            
                            <div class="receipt-field">
                                <label>Event ID:</label>
                                <div id="receiptEventId">--</div>
                                <button type="button" onclick="copyToClipboard('receiptEventId')" class="btn-copy">Copy</button>
                            </div>

                            <div class="receipt-field">
                                <label>Commitment Hash:</label>
                                <div class="hash-display" id="receiptCommitment" title="Use this to verify your ballot later">--</div>
                                <button type="button" onclick="copyToClipboard('receiptCommitment')" class="btn-copy">Copy</button>
                            </div>

                            <div class="receipt-field">
                                <label>Transaction Hash:</label>
                                <div class="hash-display" id="receiptTxHash">--</div>
                                <button type="button" onclick="copyToClipboard('receiptTxHash')" class="btn-copy">Copy</button>
                                <a id="receiptExplorerLink" href="#" target="_blank" style="display: none; margin-left: 10px; font-size: 12px;">View on Explorer</a>
                            </div>

                            <div class="receipt-field">
                                <label>Timestamp:</label>
                                <div id="receiptTimestamp">--</div>
                            </div>

                            <div class="receipt-field">
                                <label>Update Sequence:</label>
                                <div id="receiptSequence">--</div>
                            </div>
                            
                            <div class="receipt-info">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="16" height="16">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="16" x2="12" y2="12"></line>
                                    <line x1="12" y1="8" x2="12.01" y2="8"></line>
                                </svg>
                                <p>After results are released, use your commitment hash to verify your ballot was counted.</p>
                            </div>
                        </div>
                        
                        <div class="receipt-actions">
                            <button type="button" onclick="downloadReceipt()" class="btn btn-secondary">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="16" height="16">
                                    <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3"></path>
                                </svg>
                                Download Receipt
                            </button>
                            <button type="button" onclick="closeReceiptModal()" class="btn btn-primary">Done</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Verification Section -->
            <div id="verificationSection" class="verification-section" style="display: none;">
                <div class="verification-card">
                    <h2>Verify Your Ballot</h2>
                    <p>After results are released, verify that your ballot was included in the final tally.</p>
                    
                    <form id="verificationForm" class="verification-form">
                        <div class="form-group">
                            <label for="verifyCommitment">Your Commitment Hash:</label>
                            <input type="text" id="verifyCommitment" placeholder="Paste your commitment hash from your receipt" required>
                        </div>
                        <button type="submit" class="btn btn-primary">Verify My Ballot</button>
                    </form>
                    
                    <div id="verificationResult" style="display: none;"></div>
                </div>
            </div>

            <!-- Results Section (White Paper: Result Disclosure) -->
            <div id="resultsSection" class="results-section" style="display: none;">
                <h2>Election Results</h2>
                <p id="resultsNote" class="results-note"></p>
                <div id="resultsContainer"></div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p>&copy; <a href="../index.html" class="footer-link">VoteSecure</a>. Privacy-preserving voting on Nervos CKB.</p>
        </div>
    </footer>

    <!-- Scripts: Load in correct order -->
    <!-- 1. Buffer Polyfill (for Node.js Buffer compatibility in browser) -->
    <script type="module">
        import { Buffer } from 'https://cdn.jsdelivr.net/npm/buffer@6.0.3/+esm';
        window.Buffer = Buffer;
    </script>

    <!-- 2. ES Module Shims (for import maps support) -->
    <script async src="https://ga.jspm.io/npm:es-module-shims@2/dist/es-module-shims.js"></script>

    <!-- 3. Import Map (defines module locations) -->
    <script type="importmap">
    {
      "imports": {
        "@ckb-ccc/core": "https://cdn.jsdelivr.net/npm/@ckb-ccc/core/dist/index.mjs",
        "@ckb-ccc/connector-react": "https://cdn.jsdelivr.net/npm/@ckb-ccc/connector-react/dist/index.mjs"
      }
    }
    </script>

    <!-- 4. CKB Service with CCC (ES Module) - Uses JoyID with CCC library -->
    <script type="module" src="../src/ckbService_ccc.js"></script>

    <!-- 5. Voter Script (Regular script, uses globals) -->
    <script src="voter.js"></script>

</body>
</html>